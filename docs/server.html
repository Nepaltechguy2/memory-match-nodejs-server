<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>a memory match game
made by samyok nepal. (c) 2018.
no part of this may be reproduced unless one or both of the following apply:
either
  the portion that is to be reproduced is from another source
  or with written permission from the author.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>import logger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./modules/logger.js"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>import samyok – basically a collection of weird functions usable anywhere.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> samyok = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./modules/samyok.js"</span>);
<span class="hljs-keyword">var</span> mm = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./modules/global"</span>);

<span class="hljs-keyword">const</span> cardos = <span class="hljs-keyword">new</span> mm.cardMaker();
<span class="hljs-keyword">const</span> perm_cards = cardos.cards;
<span class="hljs-built_in">console</span>.log(perm_cards);

<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> roomNumber = <span class="hljs-number">1</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">randInt</span>(<span class="hljs-params">min, max</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(min + <span class="hljs-built_in">Math</span>.random() * (max + <span class="hljs-number">1</span> - min))
}
<span class="hljs-keyword">var</span> place = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>define vars and add .clean() functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> users = <span class="hljs-keyword">new</span> place();
<span class="hljs-keyword">var</span> rooms = <span class="hljs-keyword">new</span> place();
<span class="hljs-keyword">var</span> lobbies = <span class="hljs-keyword">new</span> place();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>start main express/socket server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
mm.docServers.start();
mm.server.init();

<span class="hljs-keyword">var</span> io = mm.server.io;
io.on(<span class="hljs-string">"connection"</span>, (socket)=&gt;{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>sets key to the ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> key = socket.id;
    socket.to(key).emit(<span class="hljs-string">"console"</span>, {<span class="hljs-attr">message</span>: <span class="hljs-string">"Connected!"</span>});
    users[key] = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>update users file function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateUsersFile</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"update"</span>);
        <span class="hljs-keyword">var</span> usernames = [];
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> users){
            <span class="hljs-keyword">if</span>(users[a]!=<span class="hljs-literal">null</span>){
                <span class="hljs-keyword">if</span>(users[a].username != <span class="hljs-literal">null</span>)
                usernames.push(users[a].username);
            }
        }
        <span class="hljs-keyword">var</span> file = fs.writeFile(<span class="hljs-string">'./public/onlineUsers.json'</span>, <span class="hljs-built_in">JSON</span>.stringify(usernames));
        <span class="hljs-keyword">return</span> usernames;
    }

    logger.silly(<span class="hljs-string">"Join!"</span> + key);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>send connected message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    io.to(key).emit(<span class="hljs-string">"connected"</span>, {
        <span class="hljs-attr">connected</span>: <span class="hljs-literal">true</span>
    });
    logger.debug(<span class="hljs-string">"TO "</span>+key+<span class="hljs-string">" MSG: connected"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>on user sid ….</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">"user-sid"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>get username assoc…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> usernamePromise = mm.validateSID(data.sid);
        usernamePromise.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">uname</span>)</span>{
            logger.silly(uname);
            <span class="hljs-keyword">if</span>(uname == <span class="hljs-literal">null</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>give error if no username</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                io.to(key).emit(<span class="hljs-string">"user-sid-response"</span>,  {<span class="hljs-attr">message</span>: <span class="hljs-string">"error"</span>, <span class="hljs-attr">reason</span>:<span class="hljs-string">"Please log in."</span>});
                logger.warn(<span class="hljs-string">"please log in"</span> + key + <span class="hljs-string">' : sid : '</span> + data.sid);
            } <span class="hljs-keyword">else</span> {
                io.to(key).emit(<span class="hljs-string">"user-sid-response"</span>,  {<span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>, <span class="hljs-attr">username</span>:uname});
                users[key] = {};
                users[key].username = uname;
                updateUsersFile();
                logger.debug(<span class="hljs-string">"added "</span>+key+<span class="hljs-string">" as "</span> + uname);
            }
        });
    });
    <span class="hljs-comment">/**
     * @param {string} room the room key
     * @return {void}
     */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>start game function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start_game</span>(<span class="hljs-params">room</span>) </span>{
        logger.warn(mm.cards);
        <span class="hljs-keyword">var</span> okay = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> rooms[room].ready){
            <span class="hljs-keyword">if</span>(!rooms[room].ready[a]){
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        logger.info(<span class="hljs-string">"Started game in room "</span> + room + <span class="hljs-string">"."</span>);
        rooms[room].started = <span class="hljs-number">1</span>;
        io.to(rooms[room].gameInfo.leader).emit(<span class="hljs-string">"game_start"</span>, {
            <span class="hljs-attr">first</span>: <span class="hljs-literal">true</span>
        });
        io.to(rooms[room].gameInfo.player2).emit(<span class="hljs-string">"game_start"</span>, {
            <span class="hljs-attr">first</span>: <span class="hljs-literal">false</span>
        });
        <span class="hljs-keyword">var</span> arr = <span class="hljs-string">"ABCDEFGHIJKLMNOPQR"</span>;
        arr += arr.toLowerCase();
        <span class="hljs-built_in">console</span>.log(arr);
        <span class="hljs-keyword">var</span> NUMBER_OF_CARDS = arr.length; <span class="hljs-comment">//MUST BE EVEN</span>

        super_arr = stringShuffle(arr);

        <span class="hljs-comment">/**
        * Shuffles the string
        * @param  {string} string The string that you want to shuffle
        * @return {string}       The shuffled string.
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stringShuffle</span>(<span class="hljs-params">string</span>)</span>{
           <span class="hljs-keyword">var</span> array = string.split(<span class="hljs-string">""</span>);
           <span class="hljs-keyword">var</span> randomID = <span class="hljs-number">-1</span>;
           <span class="hljs-keyword">var</span> newArray = [];
           <span class="hljs-keyword">while</span>(newArray.length != <span class="hljs-number">36</span>){

               randomID = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * (<span class="hljs-number">36</span>-newArray.length));

               newArray.push(array[randomID]);
               array.splice(randomID, <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.log(array);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           }
           <span class="hljs-keyword">return</span> newArray;
        }
        rooms[room].game.turn = <span class="hljs-string">"leader"</span>;
        rooms[room].scores = {
            <span class="hljs-attr">leader</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">player2</span>: <span class="hljs-number">0</span>
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>92 total</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rooms[room].rebus_link = randInt(<span class="hljs-number">0</span>,<span class="hljs-number">91</span>);
        rooms[room].cardPairsLeft = <span class="hljs-number">18</span>;
        rooms[room].game.card1 = <span class="hljs-literal">null</span>;
        rooms[room].game.card2 = <span class="hljs-literal">null</span>;
        rooms[room].cards = super_arr;
        logger.silly(rooms);
    }
    socket.on(<span class="hljs-string">"click_card"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{;
        <span class="hljs-keyword">var</span> room = findRoomName(key);
        logger.silly(<span class="hljs-string">'card click in room '</span>+room);
        <span class="hljs-keyword">if</span>(rooms[room]==<span class="hljs-literal">null</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span>(key == rooms[room].gameInfo[rooms[room].game.turn]){ <span class="hljs-comment">// if it is your turn ...</span>
            <span class="hljs-keyword">if</span>(rooms[room].game.card1 ==<span class="hljs-literal">null</span>){ <span class="hljs-comment">// if no cards have been chosen ...</span>
                rooms[room].game.card1 = rooms[room].cards[data.number]; <span class="hljs-comment">// then set the card clicked to card1</span>
                io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2).emit(<span class="hljs-string">"flip_card"</span>, {<span class="hljs-attr">number</span> : data.number, <span class="hljs-attr">text</span> :rooms[room].game.card1});
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rooms[room].game.card1 == rooms[room].cards[data.number]) { <span class="hljs-comment">// if the card clicked is the same as card1...</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>do nothing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rooms[room].game.card2 == <span class="hljs-literal">null</span>){ <span class="hljs-comment">// if 1 card has been chosen. ..</span>
                rooms[room].game.card2 =rooms[room].cards[data.number]; <span class="hljs-comment">// set new card to card 2</span>
                io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2).emit(<span class="hljs-string">"flip_card"</span>, {<span class="hljs-attr">number</span> : data.number, <span class="hljs-attr">text</span>: rooms[room].game.card2});
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// otherwise both cards have been clicked so now we check.</span>
                <span class="hljs-keyword">if</span>(findCP(rooms[room].game.card1)==rooms[room].game.card2.toLowerCase()){ <span class="hljs-comment">// was right</span>
                    <span class="hljs-keyword">if</span>(key == rooms[room].gameInfo.leader){ <span class="hljs-comment">// if you are the leader</span>
                        rooms[room].scores.leader++;
                        rooms[room].cardPairsLeft--;
                        io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                            .emit(<span class="hljs-string">"gameInfo"</span>, {<span class="hljs-attr">type</span>: <span class="hljs-string">"notif"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"score"</span>, <span class="hljs-attr">person</span>: <span class="hljs-string">"leader"</span>, <span class="hljs-attr">score</span>:rooms[room].scores.leader });
                    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// you are the player2</span>
                        rooms[room].scores.player2++;
                        rooms[room].cardPairsLeft--;
                        io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                            .emit(<span class="hljs-string">"gameInfo"</span>, {<span class="hljs-attr">type</span>: <span class="hljs-string">"notif"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"score"</span>, <span class="hljs-attr">person</span>: <span class="hljs-string">"player2"</span>, <span class="hljs-attr">score</span>:rooms[room].scores.player2});
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>notify
nothing wrong with .to(null)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                        .emit(<span class="hljs-string">"remove_card"</span>, {<span class="hljs-attr">number</span>: samyok.findKey(rooms[room].game.card2, rooms[room].cards)});
                    io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                        .emit(<span class="hljs-string">"remove_card"</span>, {<span class="hljs-attr">number</span>: samyok.findKey(rooms[room].game.card1, rooms[room].cards)});
                } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// was wrong</span>
                    <span class="hljs-built_in">console</span>.log(findCP(rooms[room].game.card1));
                    <span class="hljs-built_in">console</span>.log(rooms[room].game.card2);
                    <span class="hljs-keyword">if</span>(rooms[room].type == <span class="hljs-string">"single"</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>you are the leader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        rooms[room].scores.leader--;
                        io.to(rooms[room].gameInfo.leader).emit(<span class="hljs-string">"gameInfo"</span>, {<span class="hljs-attr">type</span>: <span class="hljs-string">"notif"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"score"</span>, <span class="hljs-attr">person</span>: <span class="hljs-string">"leader"</span>, <span class="hljs-attr">score</span>:rooms[room].scores.leader });

                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span>(rooms[room].game.turn == <span class="hljs-string">"leader"</span>){ <span class="hljs-comment">// switch turns</span>
                            rooms[room].game.turn = <span class="hljs-string">"player2"</span>;
                        } <span class="hljs-keyword">else</span> {
                            rooms[room].game.turn = <span class="hljs-string">"leader"</span>;
                        }
                    }
                    io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                        .emit(<span class="hljs-string">"flip_card"</span>, {<span class="hljs-attr">number</span>: samyok.findKey(rooms[room].game.card2, rooms[room].cards), <span class="hljs-attr">text</span>: <span class="hljs-string">"Don't Cheat"</span>});
                    io.to(rooms[room].gameInfo.leader).to(rooms[room].gameInfo.player2)
                        .emit(<span class="hljs-string">"flip_card"</span>, {<span class="hljs-attr">number</span>: samyok.findKey(rooms[room].game.card1, rooms[room].cards), <span class="hljs-attr">text</span>: <span class="hljs-string">"Don't Cheat"</span>});
                }
                rooms[room].game.card2 = <span class="hljs-literal">null</span>;
                rooms[room].game.card1 = <span class="hljs-literal">null</span>;
            }
        } <span class="hljs-keyword">else</span> {
            io.to(key).emit(<span class="hljs-string">"message"</span>, {<span class="hljs-attr">color</span>: <span class="hljs-string">"red"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Not your turn!"</span>});
        }
        <span class="hljs-keyword">if</span>(rooms[room].cardPairsLeft == <span class="hljs-number">0</span>){
            end_game(room);
        }
        logger.silly(rooms);
    });
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end_game</span>(<span class="hljs-params">room</span>)</span>{
        <span class="hljs-keyword">if</span>(rooms[room].type==<span class="hljs-string">"double"</span>){
            <span class="hljs-keyword">if</span>(rooms[room].scores.leader &gt; rooms[room].scores.player2){
                io.of(<span class="hljs-string">'/'</span>).emit(<span class="hljs-string">"gameUpdate"</span>, {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"fair"</span>,
                    <span class="hljs-attr">game</span>: {
                        <span class="hljs-attr">winner</span>: {
                            <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.leader].username,
                            <span class="hljs-attr">score</span>: rooms[room].scores.leader
                        },
                        <span class="hljs-attr">loser</span>: {
                            <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.player2].username,
                            <span class="hljs-attr">score</span>:  rooms[room].scores.player2
                        }
                    }
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rooms[room].scores.leader &lt; rooms[room].scores.player2) {
                io.of(<span class="hljs-string">'/'</span>).emit(<span class="hljs-string">"gameUpdate"</span>, {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"fair"</span>,
                    <span class="hljs-attr">game</span>: {
                        <span class="hljs-attr">loser</span>: {
                            <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.leader].username,
                            <span class="hljs-attr">score</span>: rooms[room].scores.leader
                        },
                        <span class="hljs-attr">winner</span>: {
                            <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.player2].username,
                            <span class="hljs-attr">score</span>:  rooms[room].scores.player2
                        }
                    }
                });
            } <span class="hljs-keyword">else</span> {
                io.of(<span class="hljs-string">'/'</span>).emit(<span class="hljs-string">"gameUpdate"</span>, {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"tie"</span>,
                    <span class="hljs-attr">game</span>: {
                        <span class="hljs-attr">winner</span>: { <span class="hljs-comment">// not really but w/e continuity</span>
                            username: users[rooms[room].gameInfo.leader].username,
                            <span class="hljs-attr">score</span>: rooms[room].scores.leader
                        },
                        <span class="hljs-attr">loser</span>: {
                            <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.player2].username,
                            <span class="hljs-attr">score</span>:  rooms[room].scores.player2
                        }
                    }
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>disconnect players so like no more notifs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            io.sockets.connected[rooms[room].gameInfo.leader].disconnect();
            io.sockets.connected[rooms[room].gameInfo.player2].disconnect();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Emit to "</span>+ rooms[room].gameInfo.leader);
            io.to(rooms[room].gameInfo.leader).emit(<span class="hljs-string">"rebus_time"</span>, {<span class="hljs-attr">rebus_link</span>: rooms[room].rebus_link});
        }

    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findRoomName</span>(<span class="hljs-params">key</span>)</span>{
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> rooms){
            <span class="hljs-keyword">if</span>(rooms[a].gameInfo.leader == key || rooms[a].gameInfo.player2 == key){
                <span class="hljs-keyword">return</span> a;
            }
        }
    }
socket.on(<span class="hljs-string">'force-end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{ <span class="hljs-comment">// for display purposes only. </span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"FORCE END ROOM"</span> + findRoomName(key));
    end_game(findRoomName(key));
})
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">kill_key</span>(<span class="hljs-params">key</span>)</span>{ <span class="hljs-comment">// Kill Key</span>
        io.to(key).emit(<span class="hljs-string">"kill"</span>, {});
        <span class="hljs-built_in">console</span>.log(key);
        <span class="hljs-built_in">console</span>.log(users[key]);
        <span class="hljs-keyword">var</span> username = users[key].username;
        <span class="hljs-built_in">console</span>.log(username + <span class="hljs-string">" just disconnected"</span>);
        <span class="hljs-keyword">delete</span> users[key];
        updateUsersFile();
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> rooms){
            <span class="hljs-keyword">if</span>(rooms[a].gameInfo.leader==key){
                rooms[a].gameInfo.leader= <span class="hljs-literal">null</span>;
                rooms[a].abandoned = username;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"deleting leader"</span>);
                abandoned_key(key, a);
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rooms[a].gameInfo.player2 == key){
                rooms[a].gameInfo.player2= <span class="hljs-literal">null</span>;
                rooms[a].abandoned = username;
                abandoned_key(key, a);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"key"</span> + key + <span class="hljs-string">'not in room. '</span>);
                <span class="hljs-built_in">console</span>.log(rooms);
            }
        }
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">abandoned_key</span>(<span class="hljs-params">key, room</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>leader still in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">console</span>.log(key+ <span class="hljs-string">" "</span> + room);
        <span class="hljs-keyword">if</span>(!rooms[room].started){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"room hasnt started or already abandoned"</span>)
            <span class="hljs-keyword">delete</span> rooms[room];
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span>(rooms[room].gameInfo.player2 ==<span class="hljs-literal">null</span> &amp;&amp; rooms[room].gameInfo.leader==<span class="hljs-literal">null</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span>(rooms[room].gameInfo.player2==<span class="hljs-literal">null</span>){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"leader won!"</span>);
            socket.broadcast.emit(<span class="hljs-string">"gameUpdate"</span>, {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"abandon"</span>,
                <span class="hljs-attr">game</span>: {
                    <span class="hljs-attr">winner</span>: {
                        <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.leader].username,
                        <span class="hljs-attr">score</span>: rooms[room].scores.leader
                    },
                    <span class="hljs-attr">loser</span>: {
                        <span class="hljs-attr">username</span>: rooms[room].abandoned,
                        <span class="hljs-attr">score</span>: <span class="hljs-string">"X"</span>
                    }
                }
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"sending to player2: "</span> + rooms[room].gameInfo.player2);
            socket.broadcast.emit(<span class="hljs-string">"gameUpdate"</span>, {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"abandon"</span>,
                <span class="hljs-attr">game</span>: {
                    <span class="hljs-attr">winner</span>: {
                        <span class="hljs-attr">username</span>: users[rooms[room].gameInfo.player2].username,
                        <span class="hljs-attr">score</span>: rooms[room].scores.player2
                    },
                    <span class="hljs-attr">loser</span>: {
                        <span class="hljs-attr">username</span>: rooms[room].abandoned,
                        <span class="hljs-attr">score</span>: <span class="hljs-number">0</span>
                    }
                }
            });
        }
        <span class="hljs-built_in">console</span>.log(rooms);
    }
    socket.on(<span class="hljs-string">"create_room"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">switch</span> (data.type) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"double"</span>:
                io.to(key).emit(<span class="hljs-string">'room_created'</span>, {
                    <span class="hljs-attr">room</span>: create_room(<span class="hljs-string">"double"</span>, key),
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"double"</span>
                })
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"single"</span>:
                <span class="hljs-keyword">var</span> theRoom = create_room(<span class="hljs-string">"single"</span>, key);
                io.to(key).emit(<span class="hljs-string">'room_created'</span>, {
                    <span class="hljs-attr">room</span>: theRoom,
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"single"</span>
                })
                io.to(key).emit(<span class="hljs-string">"game_start"</span>, {
                    <span class="hljs-attr">first</span>: <span class="hljs-literal">true</span>
                });
                rooms[theRoom].ready.leader = <span class="hljs-literal">true</span>;
                start_game(theRoom);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                io.to(key).emit(<span class="hljs-string">"error"</span>, {
                    <span class="hljs-attr">message</span>: <span class="hljs-string">"lol"</span>
                });
        }
    });
    socket.on(<span class="hljs-string">'samyok_says_restart'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        logger.warn(<span class="hljs-string">"Restart code Requested by "</span> + key);
        socket.emit(<span class="hljs-string">"console"</span>, {
            <span class="hljs-attr">href</span>: <span class="hljs-string">"restart_code="</span> + mm.server.restart_code
        });
    })
    socket.on(<span class="hljs-string">"join_room"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        join_room(data.code, key);
    });
    socket.on(<span class="hljs-string">"ready"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> rooms) {
            <span class="hljs-keyword">if</span> (rooms[a].gameInfo == <span class="hljs-literal">null</span> || rooms[a].gameInfo.leader == key) {
                <span class="hljs-keyword">var</span> other = <span class="hljs-string">"player2"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> other = <span class="hljs-string">"leader"</span>;
            }
            <span class="hljs-keyword">if</span> (rooms[a].gameInfo == <span class="hljs-literal">undefined</span>) {
                <span class="hljs-keyword">delete</span> rooms[a];
                logger.error(<span class="hljs-string">"Deleted room "</span> + a + <span class="hljs-string">", the room's info was undefined."</span>);
                logger.silly(rooms);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rooms[a].gameInfo.leader == key) {
                rooms[a].ready.leader = <span class="hljs-literal">true</span>;
                logger.info(<span class="hljs-string">"Marked "</span> + users[key].username + <span class="hljs-string">" as ready to play in room "</span> + a + <span class="hljs-string">'.'</span>);
                logger.silly(rooms);
                start_game(a);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rooms[a].gameInfo.player2 == key) {
                rooms[a].ready.player2 = <span class="hljs-literal">true</span>;
                logger.info(<span class="hljs-string">"Marked "</span> + users[key].username + <span class="hljs-string">" as ready to play in room "</span> + a + <span class="hljs-string">'.'</span>);
                logger.silly(rooms);
                start_game(a);
            }
        }
    });
    socket.on(<span class="hljs-string">"rebus_answer"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data1</span>)</span>{
        <span class="hljs-keyword">var</span> percentage = mm.getRebusAnswer(rooms[findRoomName(key)].rebus_link, data1.answer);
        <span class="hljs-built_in">console</span>.log(percentage);
        percentage.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">closeness</span>)</span>{
            <span class="hljs-built_in">console</span>.log(closeness);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Launching. "</span>)
            <span class="hljs-keyword">if</span>(closeness &gt;= <span class="hljs-number">80</span>){
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Launching. Win! "</span>)
                io.to(key).emit(<span class="hljs-string">"rebus_response"</span>, {
                    <span class="hljs-attr">game</span>: {
                        <span class="hljs-attr">winner</span>: {
                            <span class="hljs-attr">username</span>: users[key].username,
                            <span class="hljs-attr">score</span>: rooms[findRoomName(key)].scores.leader,
                            <span class="hljs-attr">got_rebus</span>: <span class="hljs-literal">true</span>
                        }
                    }
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Launching. Lose! "</span>)
                io.to(key).emit(<span class="hljs-string">"rebus_response"</span>, {
                    <span class="hljs-attr">game</span>: {
                        <span class="hljs-attr">winner</span>: {
                            <span class="hljs-attr">username</span>: users[key].username,
                            <span class="hljs-attr">score</span>: rooms[findRoomName(key)].scores.leader,
                            <span class="hljs-attr">got_rebus</span>: <span class="hljs-literal">false</span>
                        }
                    }
                });
            }
        });
    });
    socket.on(<span class="hljs-string">"disconnect"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        kill_key(key);
    })
})


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_room</span>(<span class="hljs-params">type, key</span>) </span>{ <span class="hljs-comment">// create room</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> a <span class="hljs-keyword">in</span> lobbies) {
        <span class="hljs-keyword">delete</span> lobbies[a][key];
    }
    roomNumber += randInt(<span class="hljs-number">9</span>, <span class="hljs-number">20</span>);
    <span class="hljs-keyword">var</span> room_name = <span class="hljs-string">"room"</span> + roomNumber.toString();
    rooms[room_name] = <span class="hljs-keyword">new</span> place();
    rooms[room_name].type = type;
    rooms[room_name].gameInfo = {};
    rooms[room_name].game = {};
    rooms[<span class="hljs-string">"room"</span> + roomNumber.toString()].gameInfo.leader = key;
    rooms[room_name].ready = {};
    rooms[room_name].ready.leader = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"double"</span>) {
        rooms[room_name].gameInfo.player2 = <span class="hljs-literal">null</span>;
        rooms[room_name].ready.player2 = <span class="hljs-literal">false</span>;
    }
    rooms[room_name].started = <span class="hljs-literal">false</span>;
    rooms[room_name].abandoned = <span class="hljs-literal">false</span>;
    logger.silly(rooms);
    <span class="hljs-keyword">return</span> room_name;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">join_room</span>(<span class="hljs-params">code, key</span>) </span>{ <span class="hljs-comment">// join room</span>
    <span class="hljs-keyword">if</span> (rooms[code] == <span class="hljs-literal">null</span> || rooms[code].abandoned) {
        io.to(key).emit(<span class="hljs-string">"join_response"</span>, {
            <span class="hljs-attr">message</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">reason</span>: <span class="hljs-string">"Not a real room."</span>
        });
        logger.info(key + <span class="hljs-string">" just tried to go to room "</span> + code);
        logger.silly(rooms);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        rooms[code].gameInfo.player2 = key;
        io.to(rooms[code].gameInfo.leader).emit(<span class="hljs-string">"player_joined"</span>, {
            <span class="hljs-attr">player</span>: users[key].username
        });
        logger.silly(rooms);
        io.to(key).emit(<span class="hljs-string">"join_response"</span>, {
            <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>,
            <span class="hljs-attr">code</span>: code,
            <span class="hljs-attr">player</span>: users[rooms[code].gameInfo.leader].username
        });
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findCP</span>(<span class="hljs-params">cardText</span>) </span>{ <span class="hljs-comment">// find coubter part</span>
    <span class="hljs-keyword">return</span> cardText.toLowerCase();
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
